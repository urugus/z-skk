# 要件

- zsh で SKK と同様の入力体験を得られること
- zinit でプラグインとしてインストールできること

## SKK入力モード仕様

### 入力モード一覧

1. **かなモード** - ひらがな入力（デフォルト）
2. **カナモード** - カタカナ入力
3. **英数モード** - 直接入力（ASCII）
4. **全英モード** - 全角英数入力
5. **Abbrevモード** - 略語展開モード

### モード切り替えキー

- `C-j` - かなモードへ切り替え
- `q` - カナモードへ切り替え（かなモード時）
- `l` / `L` - 英数モードへ切り替え（かなモード時）
- `/` - Abbrevモードへ切り替え（かなモード時）
- `C-q` - 全英モードへ切り替え

### 変換関連キー

- `Shift` - 変換開始（sticky shift）
  - 大文字入力で変換モード開始
  - 例: `Kanji` → 「かんじ」の変換候補表示
- `Space` - 次の変換候補
- `x` - 前の変換候補
- `C-g` - 変換キャンセル
- `Enter` - 変換確定

### 特殊キー操作

- `X` - 前の文字をカタカナに変換（かなモード時）
- `>` - 接尾辞入力開始
- `?` - 接頭辞入力開始
- `;` - コード入力（JISコード等）
- `@` - 今日の日付入力

### 辞書登録

- 変換候補がない場合、自動的に辞書登録モードへ
- 読みと漢字を入力して登録
- 個人辞書は `~/.skk-jisyo` に保存

### 辞書設定

辞書ファイルのパスは環境変数で設定可能:

- `SKK_JISYO_PATH` - 個人辞書のパス（デフォルト: `~/.skk-jisyo`）
- `SKK_USER_JISYO_PATH` - ユーザー辞書のパス（デフォルト: `~/.skk-user-jisyo`）

設定例（`.zshrc` に追加）:
```bash
export SKK_JISYO_PATH="$HOME/.config/skk/jisyo"
export SKK_USER_JISYO_PATH="$HOME/.config/skk/user-jisyo"
```

### 送り仮名の処理

- 送り仮名付き変換: 大文字→小文字で送り仮名開始
  - 例: `OkuRi` → 「送り」の変換（送り仮名「り」）
- `*` を送り仮名の位置に挿入して明示的に指定も可能

## 表示仕様

### マーカー記号

- **▽** - かな入力中・変換前の状態を示すマーカー
  - 大文字入力開始時に表示
  - 例: `Kanji` 入力中 → `▽かんじ`
  
- **▼** - 変換候補選択中を示すマーカー
  - Spaceキー押下で変換開始時に表示
  - 例: `▽かんじ` → Space → `▼漢字`

### 入力状態の表示例

1. **通常入力**
   ```
   $ nihongo
   → にほんご
   ```

2. **変換入力開始**
   ```
   $ Nihongo
   → ▽にほんご
   ```

3. **変換候補選択**
   ```
   $ Nihongo [Space]
   → ▼日本語
   ```

4. **送り仮名付き入力**
   ```
   $ OkuRi
   → ▽おくり
   $ OkuRi [Space]
   → ▼送り
   ```

### モード表示

各モードでのプロンプト表示（実装時の参考）:
- かなモード: `[あ]` または表示なし
- カナモード: `[ア]`
- 英数モード: `[_A]`
- 全英モード: `[Ａ]`
- Abbrevモード: `[aA]`

## アーキテクチャー設計

### 概要

zsh-skkはzshのプラグインとして実装され、zleウィジェットとzshの機能を活用してSKK入力を実現する。

### モジュール構成

```
z-skk/
├── z-skk.plugin.zsh      # メインプラグインファイル（zinit用）
├── lib/
│   ├── core.zsh          # コア機能（初期化、状態管理）
│   ├── modes.zsh         # 入力モード管理
│   ├── conversion.zsh    # 変換エンジン
│   ├── dictionary.zsh    # 辞書管理
│   ├── display.zsh       # 表示制御
│   ├── keybindings.zsh   # キーバインディング
│   └── utils.zsh         # ユーティリティ関数
├── dict/
│   └── SKK-JISYO.L      # システム辞書（オプション）
└── tests/
    └── test_*.zsh       # テストスクリプト
```

### コンポーネント詳細

#### 1. コア機能 (core.zsh)
- プラグインの初期化
- グローバル状態の管理
- 他モジュールの読み込み
- 環境変数の処理

```zsh
# 主要な状態変数
typeset -g SKK_MODE="hiragana"  # 現在の入力モード
typeset -g SKK_CONVERTING=0     # 変換中フラグ
typeset -g SKK_BUFFER=""        # 入力バッファ
typeset -g SKK_CANDIDATES=()    # 変換候補リスト
typeset -g SKK_CANDIDATE_INDEX=0 # 現在の候補インデックス
```

#### 2. 入力モード管理 (modes.zsh)
- モード切り替えロジック
- モード別の入力処理
- モード状態の保持

```zsh
# モード定義
readonly -A SKK_MODES=(
    [hiragana]="かな"
    [katakana]="カナ"
    [ascii]="英数"
    [zenkaku]="全英"
    [abbrev]="Abbrev"
)
```

#### 3. 変換エンジン (conversion.zsh)
- ローマ字→かな変換
- かな→漢字変換
- 送り仮名処理
- 候補選択ロジック

#### 4. 辞書管理 (dictionary.zsh)
- 辞書ファイルの読み込み
- 辞書検索
- 新規単語登録
- 辞書の保存

#### 5. 表示制御 (display.zsh)
- マーカー（▽、▼）の表示
- 候補表示
- プロンプト更新
- RPROMPT でのモード表示

#### 6. キーバインディング (keybindings.zsh)
- zleウィジェットの定義
- キーマップの設定
- イベントハンドリング

### 実装アプローチ

#### 1. ZLEウィジェットベース
```zsh
# カスタムウィジェットの定義
function skk-self-insert() {
    # 文字入力処理
}
zle -N skk-self-insert

# キーバインディング
bindkey -M emacs "a" skk-self-insert
```

#### 2. 状態管理
- zsh変数での状態保持
- 関数スコープでのローカル状態
- undo/redoのサポート

#### 3. イベント駆動
```zsh
# preexecフックで入力完了処理
add-zsh-hook preexec skk-preexec-hook

# zle-line-initでモード初期化
zle -N zle-line-init skk-line-init
```

#### 4. 辞書アクセス
- 起動時に辞書をメモリに読み込み（高速化）
- 連想配列での候補管理
- 差分更新による効率的な保存

### 技術的考慮事項

#### 1. パフォーマンス
- 辞書データのキャッシング
- 遅延読み込み
- 最小限の再描画

#### 2. 互換性
- zsh 5.0以降をサポート
- 既存のzleカスタマイズとの共存
- vi/emacsモードの考慮

#### 3. 拡張性
- プラグインアーキテクチャ
- カスタム辞書の追加
- ユーザー定義の変換ルール

### 初期化フロー

1. プラグイン読み込み（zinit）
2. 環境変数チェック
3. 辞書ファイル読み込み
4. キーバインディング設定
5. フック登録
6. 初期モード設定

## 実装方針

### 開発アプローチ

#### TDD（テスト駆動開発）
- 各機能の実装前にテストを作成
- 最小限の実装で1つずつテストをパス
- リファクタリングで品質向上

#### インクリメンタル開発
- 小さな機能単位で実装
- 各ステップで動作確認
- ユーザーフィードバックを即座に反映

### 実装ステップ

#### Phase 1: 基盤構築
1. **プラグイン基本構造**
   - [x] z-skk.plugin.zsh の作成
   - [x] ディレクトリ構造の作成
   - [x] 基本的な読み込みテスト

2. **コア機能の実装**
   - [ ] 状態変数の定義
   - [ ] 初期化関数
   - [ ] 基本的なテストフレームワーク

#### Phase 2: 基本入力
3. **英数モード実装**
   - [ ] パススルー入力（通常のzsh入力）
   - [ ] モード切り替えなし
   - [ ] 最小限の動作確認

4. **かなモード基礎**
   - [ ] ローマ字→ひらがな変換テーブル
   - [ ] 単一文字変換（a→あ）
   - [ ] 基本的なローマ字入力（ka→か）

#### Phase 3: モード管理
5. **モード切り替え**
   - [ ] C-j でかなモード
   - [ ] l で英数モード
   - [ ] モード状態の保持

6. **モード表示**
   - [ ] RPROMPTでのモード表示
   - [ ] モードインジケーター

#### Phase 4: 変換機能
7. **変換開始の実装**
   - [ ] 大文字入力での変換開始
   - [ ] ▽マーカーの表示
   - [ ] バッファ管理

8. **簡易辞書機能**
   - [ ] ハードコードされた辞書
   - [ ] 基本的な変換（かんじ→漢字）
   - [ ] Space での変換実行

#### Phase 5: 候補選択
9. **候補管理**
   - [ ] 複数候補の管理
   - [ ] Space/x での候補切り替え
   - [ ] ▼マーカーの表示

10. **変換確定**
    - [ ] Enter での確定
    - [ ] C-g でのキャンセル
    - [ ] 状態のリセット

#### Phase 6: 辞書機能
11. **辞書ファイル読み込み**
    - [ ] 基本的な辞書フォーマット
    - [ ] ファイル読み込み
    - [ ] メモリへのロード

12. **辞書登録**
    - [ ] 新規単語の登録
    - [ ] 辞書ファイルへの保存
    - [ ] 登録UIの実装

#### Phase 7: 高度な機能
13. **送り仮名処理**
    - [ ] 送り仮名の検出
    - [ ] 送り仮名付き変換
    - [ ] 活用形の処理

14. **その他の入力モード**
    - [ ] カタカナモード
    - [ ] 全角英数モード
    - [ ] Abbrevモード

### テスト戦略

#### ユニットテスト
```zsh
# tests/test_conversion.zsh
test_romaji_to_hiragana() {
    source ../lib/conversion.zsh
    
    # 単一文字
    assert_equals "$(romaji_to_kana 'a')" "あ"
    assert_equals "$(romaji_to_kana 'ka')" "か"
    
    # 促音
    assert_equals "$(romaji_to_kana 'tta')" "った"
}
```

#### 統合テスト
```zsh
# tests/test_integration.zsh
test_basic_input() {
    # 実際のzle環境をシミュレート
    simulate_keys "Kanji "
    assert_buffer_equals "漢字"
}
```

### 動作確認手順

各実装ステップ後:
1. テストの実行: `zsh tests/run_all.zsh`
2. 手動確認: `source z-skk.plugin.zsh`
3. 実際の入力テスト
4. フィードバックの収集

### コミット方針

- 各機能実装ごとにコミット
- テストとセットでコミット
- コミットメッセージ: `feat: [機能名] の実装`

### 検証環境

```bash
# 開発用シェルセッション
$ cd z-skk
$ source z-skk.plugin.zsh
$ # 動作確認
```

### フィードバックループ

1. 小機能の実装
2. テスト作成・実行
3. ユーザー動作確認
4. 問題があれば即座に修正
5. 次の機能へ


